#######################################################################################################################
# Title: Install CentOS 6 Server (or any Rhel-based distro), join it to Active Directory for Centralized Authentication#, and Join to in-house Spacewalk Server for Patching
#
# Author:ATHANASIUS C. KEBEI
# REFERENCES: http://dl.fedoraproject.org
# http://www.centos.org/docs/5/html/Installation_Guide-en-US/ch-kickstart2.html
# http://download.fedora.redhat.com
#######################################################################################################################
# Kickstart file automatically generated by anaconda.
#platform=x86, AMD64, or Intel EM64T
firewall --enabled --http --ssh --service=http,ssh
install
# Use NFS installation media Kickstart file lo#cation
nfs --server=192.168.1.23 --dir=/nfs/CentOS6.5
rootpw --iscrypted $1$EbgAo7h8$waT9gBpTPDmBz1t6OPK1x1
user --name=akebei_admin --password=!C0ntro1
# System authorization information
auth  --useshadow  --passalgo=sha512 --enablekrb5 --krb5realm=NEUSTAR.NET --krb5kdc=dc01.nestart.net --krb5adminserver=dc01.neustar.net
graphical
firstboot --disable
keyboard us
lang en_US.UTF-8
# SELinux configuration
selinux --enforcing
reboot
timezone  America/New_York
# Network information
network  --bootproto=dhcp --noipv6 --device=eth0 --onboot=on
# System bootloader configuration
zerombr
bootloader --location=mbr --driveorder=sda --append="crashkernel=auto rhgb quiet"
clearpart --all --drives=sda --initlabel

part /boot --fstype=ext4 --size=500
part pv.008002 --grow --size=1

volgroup vg_kickstart --pesize=4096 pv.008002
logvol / --fstype="ext4" --name=lv_root --vgname=vg_kickstart --grow --size=1024 --maxsize=51200
logvol swap --name=lv_swap --vgname=vg_kickstart --grow --size=1008 --maxsize=3000

%packages --ignoremissing
@base
@base-x
@basic-desktop
@desktop-debugging
@cifs-file-server
@directory-server
@emacs
@ftp-server
@graphical-admin-tools
@internet-browser
@general-desktop
@network-file-system-client
@network-server
@network-tools
@nfs-file-server
@performance
@security-tools
@system-admin-tools
@x11
crypto-utils
krb5-appl-clients
krb5-appl-servers
krb5-pkinit-openssl
krb5-server
krb5-server-ldap
krb5-workstation
oddjob  
pam_krb5
samba
samba-client 
samba-common  
samba-winbind
samba-winbind-clients
system-config-date.noarch
system-config-firewall.noarch
system-config-firewall-base.noarch
system-config-firewall-tui.noarch
system-config-lvm
system-config-services.noarch
system-config-users.noarch
system-config-network-tui.noarch
vim-X11
yum-cron
yum-plugin-aliases
yum-plugin-changelog
yum-plugin-downloadonly
yum-plugin-fastestmirror
yum-plugin-security
yum-plugin-tmprepo
yum-plugin-verify
yum-plugin-versionlock
yum-presto

%post --nochroot
# Let us enable Active Directory authentication on our new centOS 6 Server. Check if the necessary packages are install.
# From the above kickstart they are but, no harm with:
yum -y install samba-client samba-common samba samba-winbind samba-winbind-clients pam_krb5 krb5-workstation oddjob

# Backup config files that maybe edited!!! 
cp /etc/krb5.conf > /etc/krb5.conf.preAD
cp /etc/samba/smb.conf /etc/samba/smb.conf.preAD
cp /etc/pam.d/login /etc/pam.d/login.preAD
cp /etc/pam.d/sudo /etc/pam.d/sudo.preAD

cat > /etc/krb5.conf << EOF
[logging]
 default = FILE:/var/log/krb5libs.log
 kdc = FILE:/var/log/krb5kdc.log
 admin_server = FILE:/var/log/kadmind.log

[libdefaults]
 default_realm = NEUSTAR.NET
 dns_lookup_realm = true
 dns_lookup_kdc = true
 ticket_lifetime = 24h
 renew_lifetime = 7d
 forwardable = true

[realms]
 NEUSTAR.NET = {
  kdc = dc01.neustar.net
  admin_server = dc01.neustar.net
 }

 NEUSTAR.NET = {
  kdc = dc01.neustar.net
  admin_server = dc01.neustar.net
  kdc = dc01.neustar.net
  
  [domain_realm]
 neustar.net = NEUSTAR.NET
 .neustar.net = NEUSTAR.NET
EOF

# Join client server to AD authentication with admin user superme and password !C0ntro1
/usr/bin/net join -w NEUSTAR -S dc01.neustar.net -U superme
!C0ntro1

# Fix up pam.d with the folowing info
echo -e 'session    required  pam_mkhomedir.so skel=/etc/skel/ umask=0022' >> /etc/pam.d/sshd
echo -e 'session    optional  pam_oddjob_mkhomedir.so umask=0022 skel=/etc/skel' >> /etc/pam.d/system-auth

cp /etc/pam.d/sshd /etc/pam.d/login
cp /etc/pam.d/sshd /etc/pam.d/sudo


# Replace some lines in the /etc/samba/smb.conf or manually make the entry replace the entire file 
cat >> /etc/samba/smb.conf << EOF 
winbind use default domain = true
template homedir = /home/NEUSTAR/%U
EOF 

# Create /home/Neustar on newly created server and enable persistence accross reboots of the following services 
mkdir /home/NEUSTAR
chmod 711 /home/NEUSTAR
chkconfig oddjobd on
chkconfig smb on
chkconfig winbind on

# Add Admin users to sudoers
echo -e 'akebei ALL=(ALL) ALL' >> /etc/sudoers
echo -e 'asohrad ALL=(ALL) ALL' >> /etc/sudoers
echo -e 'nathaniel ALL=(ALL) ALL' >> /etc/sudoers
/usr/sbin/useradd akebei
/usr/sbin/useradd asohrad
/usr/sbin/useradd nathaniel

# Join client server to our spacewalk server or Redhat Network Server for centralized patching via web ui. Create
# dir old and move local/existing repos into it
cd /etc/yum.repos.d && mkdir old && mv * old

# Create Repo for CentOS 5 and 6 spacewalk-clients by installing spacewalk-client repos
rpm -Uvh http://yum.spacewalkproject.org/2.0-client/RHEL/5/x86_64/spacewalk-client-repo-2.0-3.el5.noarch.rpm
rpm -Uvh http://yum.spacewalkproject.org/2.0-client/RHEL/6/x86_64/spacewalk-client-repo-2.0-3.el6.noarch.rpm

# Also install the EPEL Repos
# EPEL 5
echo 'BASEARCH=$(uname -i)' >> /etc/yum/repos.d/epel.repo					
rpm -Uvh http://dl.fedoraproject.org/pub/epel/5/x86_64/epel-release-5-4.noarch.rpm

# EPEL 6
echo 'BASEARCH=$(uname -i)' >> /etc/yum/repos.d/epel.repo
rpm -Uvh http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm 
 
# Install client packages:									
yum -y install rhn-client-tools rhn-check rhn-setup rhnsd m2crypto yum-rhn-plugin

# Register client to Neustar spacewalk server or Redhat Network Satellite Server
rhnreg_ks --serverUrl=http://spacewalker1.neustar.net/XMLRPC --activationkey=1-a81b2223414336d70a007c39f6f2b7f3 


#Automate updates to client
yum -y install osad python-haslib
cd /usr/share/rhn/ && wget https://spacewalker1.neustar.net/pub/RHN-ORG-TRUSTED-SSL-CERT
echo  -e 'osa_ssl_cert = /usr/share/rhn/RHN-ORG-TRUSTED-SSL-CERT' >> /etc/sysconfig/rhn/osad.conf

chkconfig osad on && service osad start

# Add repo GPG public keys for package updates
wget http://download.fedora.redhat.com/pub/epel/RPM-GPG-KEY-EPEL
mv -f RPM-GPG-KEY-EPEL /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL
# rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL
wget http://www.redhat.com/security/37017186.txt
mv -f 37017186.txt /etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release
rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release
# wget http://spacewalk.redhat.com/yum/RPM-GPG-KEY-spacewalk
mv -f RPM-GPG-KEY-spacewalk /etc/pki/rpm-gpg/RPM-GPG-KEY-spacewalk
rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-spacewalk
wget http://dag.wieers.com/packages/RPM-GPG-KEY.dag.txt
mv -f RPM-GPG-KEY.dag.txt /etc/pki/rpm-gpg/RPM-GPG-KEY-dag
rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-dag
rhn_check
yum clean all && yum makecache  && yum -y update
shutdown -r now

%end
